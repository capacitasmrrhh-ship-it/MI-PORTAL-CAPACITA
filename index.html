<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Capacita SM</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root { --verde-primario:#98C15E; --verde-oscuro:#16471C; --gris-medio:#747972; --gris-oscuro:#161617; --verde-claro:#DCE6D4; --negro:#000000; --blanco:#FFFFFF; }
html,body{ margin:0; padding:0; width:100%; height:100%; font-family:Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif; background:var(--verde-claro);} 
@media (max-width:768px){ body{ background:var(--verde-claro); color:var(--gris-oscuro);} }
.seccion{ background:rgba(255,255,255,0.95); padding:20px; border-radius:10px; margin:20px auto; max-width:960px; box-shadow:0 2px 10px rgba(0,0,0,.1);} 
h2{ color:var(--verde-oscuro); text-align:center; padding:20px; margin:0; background:#f8f9fa; border-bottom:1px solid #eaecef; }
button,.boton-volver{ background:var(--verde-primario); color:var(--blanco); border:none; padding:12px 20px; border-radius:6px; font-size:16px; margin:10px 5px; cursor:pointer; transition:.3s; box-shadow:0 2px 4px rgba(0,0,0,.1);} 
button:hover,.boton-volver:hover{ background:var(--verde-oscuro); transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.2);} 
button:active,.boton-volver:active{ transform:translateY(0); box-shadow:0 2px 3px rgba(0,0,0,.1);} 
#menuPrincipal{ padding:30px 20px;} #menuPrincipal h2{ margin-bottom:25px; font-size:18px;} #menuPrincipal button{ border:1px solid var(--verde-oscuro); padding:14px 0; }
#seccionTrabajador input{ font-size:18px; padding:12px 15px; border:1px solid #ddd; border-radius:6px; width:100%; margin-bottom:20px; transition:border-color .3s, box-shadow .3s; }
#seccionTrabajador input:focus{ outline:none; border-color:#2E5EAA; box-shadow:0 0 0 2px rgba(46,94,170,.2); }
#seccionTrabajador .botones-container{ display:flex; gap:15px; margin-top:20px; }
#seccionTrabajador .botones-container button{ flex:1; }
#mosaicoCursos{ display:none; max-width:1200px; background:transparent; box-shadow:none; }
#gridCursos{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin:20px 0; }
.curso-tile{ background:#fff; padding:20px; text-align:center; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1); cursor:pointer; transition:.3s; display:flex; flex-direction:column; align-items:center; border:2px solid var(--verde-oscuro);} 
.curso-tile:hover{ transform:translateY(-5px); box-shadow:0 4px 15px rgba(0,0,0,.2); background:var(--verde-oscuro); color:#fff; }
#contenedorModulos{ padding:25px; }
.modulo{ margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #eee; }
.modulo-titulo{ color:var(--verde-oscuro); border-bottom:2px solid var(--verde-primario); padding-bottom:10px; margin-bottom:15px; }
.contenido-modulo{ margin-bottom:20px; }
h3{ color:var(--verde-oscuro); border-bottom:2px solid var(--verde-primario); padding-bottom:8px; margin-top:25px; }
h4{ color:var(--verde-oscuro); margin-top:20px; }
ul{ padding-left:20px; } li{ margin-bottom:8px; } strong{ color:var(--verde-oscuro); }
.pregunta{ font-weight:bold; margin:20px 0 15px; color:var(--verde-oscuro); font-size:18px; }
.opciones-eval{ display:flex; flex-direction:column; gap:10px; margin:15px 0; }
.opcion-btn{ text-align:left; padding:12px 15px; background:#f8f9fa; color:#333; border:1px solid #ddd; border-radius:6px; transition:.3s; cursor:pointer; }
.opcion-btn:hover{ background:#e9ecef; border-color:#ced4da; }
.botones-navegacion{ display:flex; justify-content:space-between; margin-top:30px; }
.final-curso{ text-align:center; padding:30px; } .final-curso h3{ color:var(--verde-oscuro); border-bottom:none; font-size:26px; }
.resultado{ margin-top:15px; padding:10px; border-radius:5px; display:none; }
.correcto{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
.incorrecto{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
.certificado-btn{ background:var(--verde-oscuro); font-size:18px; padding:15px 30px; margin:20px auto; display:block; }
.certificado-btn:hover{ background:var(--verde-primario); }
#panelEmpresa{ display:none; height:100vh; width:100%; background:var(--verde-claro); font-family:Calibri,sans-serif; }
#menuLateral{ width:300px; background:var(--verde-claro); padding:25px 15px; box-shadow:3px 0 10px rgba(0,0,0,.15); display:flex; flex-direction:column; }
#menuLateral h3{ font-size:1.5rem; margin-bottom:5px; text-align:center; padding-bottom:15px; border-bottom:2px solid var(--verde-primario); color:var(--verde-oscuro); }
#menuLateral p{ text-align:center; margin-bottom:30px; font-size:.95rem; color:var(--gris-oscuro); }
#menuLateral button{ background:var(--verde-primario); color:var(--blanco); border:none; padding:12px 15px; margin:8px 0; border-radius:6px; font-size:1rem; cursor:pointer; transition:.3s; text-align:left; display:flex; align-items:center; }
#menuLateral button:hover{ background:var(--verde-oscuro); transform:translateX(5px);} 
#menuLateral button::before{ content:"→"; margin-right:10px; transition:.3s; } 
#menuLateral button:hover::before{ transform:translateX(3px);} 
#contenidoEmpresa{ flex-grow:1; padding:30px; background:var(--blanco); margin:20px; border-radius:12px; overflow-y:auto; box-shadow:0 2px 15px rgba(0,0,0,.08);} 
 table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:25px; border-radius:8px; overflow:hidden; box-shadow:0 1px 10px rgba(0,0,0,.1);} 
 th,td{ padding:14px 16px; text-align:left; border:1px solid var(--gris-medio);} 
 th{ background:var(--verde-oscuro); color:var(--blanco); font-weight:600; position:sticky; top:0; } 
 tr:nth-child(even){ background:var(--verde-claro);} tr:hover{ background:rgba(152,193,94,.2);} 
 td input{ width:100%; border:1px solid var(--gris-medio); background:var(--blanco); padding:8px; border-radius:4px; transition:.2s; } 
 td input:focus{ outline:none; border-color:var(--verde-primario); box-shadow:0 0 0 2px rgba(152,193,94,.3);} 
 @media (max-width:768px){ #panelEmpresa{ flex-direction:column;} #menuLateral{ width:100%; padding:15px;} #contenidoEmpresa{ margin:10px; padding:20px;} table{ display:block; overflow-x:auto;} #gridCursos{ grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); } }
 input[type="text"],input[type="password"],input[type="date"],input[type="number"],select,textarea{ width:100%; padding:10px; margin:8px 0; border:1px solid #ddd; border-radius:4px; box-sizing:border-box; }
 #tablaCapacitaciones{ width:100%; border-collapse:collapse; margin-top:20px; } 
 #tablaCapacitaciones th,#tablaCapacitaciones td{ padding:12px; border:1px solid #ddd; text-align:left; } 
 #tablaCapacitaciones th{ background:#2E5EAA; color:#fff; }
 #listaTrabajadores{ border:1px solid #ddd; border-radius:4px; padding:5px; } 
 #listaParticipantes{ border:1px solid var(--verde-primario); background:var(--blanco); padding:10px; border-radius:4px; } 
 .participante-item{ display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--gris-medio);} 
 .participante-item:last-child{ border-bottom:none; }
 /* Modal */
 #modalDetalle{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; overflow:auto; }
 #modalContenido{ background:#fff; margin:50px auto; padding:20px; border-radius:8px; max-width:900px; }
</style>
</head>
<body>
<section id="menuPrincipal" class="seccion" style="text-align:center;">
  <h2>ACCESO</h2>
  <div style="display:flex; flex-direction:column; align-items:center; gap:15px; max-width:300px; margin:0 auto;">
    <button onclick="mostrarTrabajador()" style="width:200px;">Trabajadores</button>
    <button onclick="mostrarLoginEmpresa()" style="width:200px;">Empresas</button>
  </div>
</section>

<section id="seccionTrabajador" class="seccion" style="display:none">
  <h2 style="color:#2E5EAA; margin-bottom:25px;">Ingrese su RUT</h2>
  <input type="text" id="rutAcceso" placeholder="Ej: 12.345.678-9" inputmode="text" autocomplete="off" />
  <div class="botones-container">
    <button class="boton-volver" onclick="volverMenu()">Volver</button>
    <button onclick="accederTrabajador()">Entrar</button>
  </div>
</section>

<section id="mosaicoCursos" class="seccion" style="display:none">
  <h2>Capacitaciones</h2>
  <div id="gridCursos">
    <div class="curso-tile" onclick="verCurso('Prevención de Incendios y Uso de Extintores')">Prevención de Incendios y Uso de Extintores</div>
    <div class="curso-tile" onclick="verCurso('EPP - Uso y Mantención')">EPP - Uso y Mantención</div>
    <div class="curso-tile" onclick="verCurso('Procedimientos de Trabajo Seguro')">Procedimientos de Trabajo Seguro</div>
    <div class="curso-tile" onclick="verCurso('Manejo Seguro de Herramientas')">Manejo Seguro de Herramientas</div>
    <div class="curso-tile" onclick="verCurso('Manejo Seguro de Material Cortopunzante')">Manejo Seguro de Material Cortopunzante</div>
    <div class="curso-tile" onclick="verCurso('Prevención de Riesgos Eléctricos')">Prevención de Riesgos Eléctricos</div>
    <div class="curso-tile" onclick="verCurso('Manejo Manual de Cargas')">Manejo Manual de Cargas</div>
    <div class="curso-tile" onclick="verCurso('Prácticas Seguras en Labores de Aseo')">Prácticas Seguras en Labores de Aseo</div>
    <div class="curso-tile" onclick="verCurso('Manipulación Higiénica de Alimentos')">Manipulación Higiénica de Alimentos</div>
    <div class="curso-tile" onclick="verCurso('Seguridad en Máquinas Panadería')">Seguridad en Máquinas Panadería</div>
    <div class="curso-tile" onclick="verCurso('Comportamientos Seguros en Cocinas y Restaurant')">Comportamientos Seguros en Cocinas y Restaurant</div>
    <div class="curso-tile" onclick="verCurso('Trayecto Seguro')">Trayecto Seguro</div>
    <div class="curso-tile" onclick="verCurso('Prevención y Respuesta a Incendios')">Prevención y Respuesta a Incendios</div>
    <div class="curso-tile" onclick="verCurso('Seguridad Frente a Incendios')">Seguridad Frente a Incendios</div>
    <div class="curso-tile" onclick="verCurso('Gestión de Riesgos de Desastres')">Gestión de Riesgos de Desastres</div>
    <div class="curso-tile" onclick="verCurso('Protocolo PREXOR - Exposición a Ruido')">Protocolo PREXOR - Exposición a Ruido</div>
    <div class="curso-tile" onclick="verCurso('Manejo Post Exposición a Sangre')">Manejo Post Exposición a Sangre</div>
    <div class="curso-tile" onclick="verCurso('Prevención Acoso Laboral y Sexual')">Prevención Acoso Laboral y Sexual</div>
    <div class="curso-tile" onclick="verCurso('Violencia y Acoso en el Trabajo')">Violencia y Acoso en el Trabajo</div>
    <div class="curso-tile" onclick="verCurso('Primeros Auxilios Psicológicos')">Primeros Auxilios Psicológicos</div>
    <div class="curso-tile" onclick="verCurso('Seguridad en Asaltos - Comercio')">Seguridad en Asaltos - Comercio</div>
    <div class="curso-tile" onclick="verCurso('Seguridad para Reponedores Fiambrerías')">Seguridad para Reponedores Fiambrerías</div>
  </div>
  <button class="boton-volver" onclick="volverTrabajador()">Volver</button>
</section>

<section id="moduloCurso" class="seccion" style="display:none">
  <h2>Curso: <span id="tituloCurso"></span></h2>
  <div id="contenedorModulos"></div>
</section>

<section id="loginEmpresa" class="seccion" style="display:none">
  <h2>Acceso Empresas</h2>
  <input type="text" id="usuarioEmpresa" placeholder="Usuario" autocomplete="username" />
  <input type="password" id="claveEmpresa" placeholder="Contraseña" autocomplete="current-password" />
  <button onclick="accederEmpresa()">Entrar</button>
  <button class="boton-volver" onclick="volverMenu()">Volver</button>
</section>

<div id="panelEmpresa">
  <div id="menuLateral">
    <h3>Empresa vwXYZ</h3>
    <p>RUT: 12.345.678-9</p>
    <button onclick="mostrarSeccion('gestionTrabajadores')">Gestión de Trabajadores</button>
    <button onclick="mostrarSeccion('registroCapacitaciones')">Registro de Capacitaciones</button>
    <button onclick="volverMenu()">Cerrar Sesión</button>
  </div>
  <div id="contenidoEmpresa">
    <div id="gestionTrabajadores">
      <h2>Listado de Trabajadores</h2>
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; margin-bottom:20px;">
        <input type="text" id="nombre" placeholder="Nombre" />
        <input type="text" id="rut" placeholder="RUT" />
        <input type="text" id="cargo" placeholder="Cargo" />
        <input type="text" id="centro" placeholder="Centro" />
        <input type="date" id="fechaIngreso" />
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button onclick="registrarTrabajador()">Agregar Trabajador</button>
        <input type="file" id="fileImport" accept=".csv,.xlsx" onchange="importarTrabajadores(this)" />
        <button onclick="exportarTrabajadores()">Exportar Trabajadores (CSV)</button>
      </div>
      <div style="margin:20px 0;">
        <input type="text" id="filtroTrabajadores" placeholder="Filtrar por nombre, RUT o cargo" oninput="filtrarTrabajadores()" />
      </div>
      <table>
        <thead>
          <tr>
            <th>RUT</th><th>Nombre</th><th>Cargo</th><th>Centro</th><th>Fecha Ingreso</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaTrabajadores"></tbody>
      </table>
    </div>

    <div id="registroCapacitaciones" style="display:none;">
      <h2>Registro de Capacitaciones</h2>
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
        <button onclick="nuevaCapacitacion()">Nueva Capacitación</button>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="text" id="filtroCapacitaciones" placeholder="Filtrar por curso o fecha" oninput="filtrarCapacitaciones()" style="width:260px;" />
          <button onclick="exportarCapacitaciones()">Exportar a PDF</button>
        </div>
      </div>

      <div id="formularioCapacitacion">
        <h3>Datos de la Capacitación</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
          <div>
            <label>Nombre de la actividad:</label>
            <input type="text" id="nombreActividad" />
          </div>
          <div>
            <label>Fecha inicio y fin:</label>
            <div style="display:flex; gap:10px;">
              <input type="date" id="fechaInicio" style="flex:1;" />
              <input type="date" id="fechaFin" style="flex:1;" />
            </div>
          </div>
          <div>
            <label>Modalidad:</label>
            <select id="modalidad"><option value="Presencial">Presencial</option><option value="E-learning">E-learning</option></select>
          </div>
          <div>
            <label>N° de horas:</label>
            <input type="number" id="horasCapacitacion" min="1" step="1" />
          </div>
          <div>
            <label>Tipo de actividad:</label>
            <select id="tipoActividad"><option value="Interna">Interna</option><option value="Externa">Externa</option></select>
          </div>
          <div id="responsableContainer">
            <label>Responsable:</label>
            <input type="text" id="responsable" />
          </div>
          <div style="grid-column:span 2;">
            <label>Grupo objetivo - Observaciones:</label>
            <textarea id="grupoObjetivo" style="width:100%; height:80px;"></textarea>
          </div>
        </div>

        <h3 style="margin-top:20px;">Participantes</h3>
        <div style="margin-bottom:15px;">
          <select id="listaTrabajadoresSelect" multiple style="width:100%; height:150px; margin-bottom:10px;"></select>
          <button onclick="agregarParticipantes()">Agregar Participantes</button>
        </div>
        <div id="listaParticipantes" style="margin-bottom:20px;"></div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button class="boton-volver" onclick="cancelarCapacitacion()">Cancelar</button>
          <button onclick="guardarCapacitacion()">Guardar Capacitación</button>
        </div>
      </div>

      <table id="tablaCapacitaciones">
        <thead>
          <tr>
            <th>Nombre Actividad</th>
            <th>Fecha</th>
            <th>Modalidad</th>
            <th>Horas</th>
            <th>Participantes</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listaCapacitaciones"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Detalle -->
<div id="modalDetalle">
  <div id="modalContenido"></div>
</div>

<script>
// ====== Estado global ======
const usuarioValido = "empresa";
const claveValida = "1234";
let trabajadores = JSON.parse(localStorage.getItem("trabajadores")) || [];
let actual = 0; let cursoActual = "";
let capacitaciones = JSON.parse(localStorage.getItem("capacitaciones")) || [];
let participantesTemporales = [];

// ====== Utilidades RUT ======
function normalizarRut(rut){ return rut.replace(/\.|\s/g,'').toUpperCase(); }
function formatearRut(rut){ rut = normalizarRut(rut); const dv = rut.slice(-1); let cuerpo = rut.slice(0,-1); let salida=''; while(cuerpo.length>3){ salida='.'+cuerpo.slice(-3)+salida; cuerpo=cuerpo.slice(0,-3);} return cuerpo+salida+'-'+dv; }
function validarRut(rut){ rut=normalizarRut(rut); if(!/^\d{7,8}[\dkK]$/.test(rut)) return false; const cuerpo=rut.slice(0,-1); let dv=rut.slice(-1); let suma=0,m=2; for(let i=cuerpo.length-1;i>=0;i--){ suma+=parseInt(cuerpo[i],10)*m; m = m===7 ? 2 : m+1; } const resto=11-(suma%11); const digito= resto===11?'0': resto===10?'K': String(resto); return digito===dv; }

// ====== Cursos ======
const cursos = {
  "Prevención de Incendios y Uso de Extintores": [
    { tipo:'texto', contenido:`<h3>¿Qué aprenderemos?</h3><ul><li>Fundamentos básicos de prevención de incendios.</li><li>Métodos de prevención y extinción.</li><li>Técnicas de uso de extintores.</li><li>Tipos de extintores, agentes y mantenimiento.</li></ul>` },
    { tipo:'texto', contenido:`<h3>Declaración de Igualdad de Género</h3><p>Usaremos lenguaje inclusivo; se permite masculino genérico por claridad.</p>` },
    { tipo:'final', contenido:`<div class="final-curso"><h3>¡Felicidades!</h3><p>Has completado exitosamente el curso:</p><p><strong>Prevención de Incendios y Uso de Extintores</strong></p><p>Ahora puedes generar tu certificado de aprobación.</p><button class="certificado-btn" onclick="generarCertificado()">Generar Certificado</button></div>` }
  ],
  "Manejo Manual de Cargas": [
    { tipo:'texto', contenido:`<h3>Introducción y Marco Legal</h3><p><strong>Definición (Art. 2 DS 63/2005):</strong> Operaciones de transporte o sujeción de carga que por sus características o condiciones ergonómicas entrañen riesgos.</p><h3>Objetivo</h3><ul><li>Identificar puestos con MMC y evaluar riesgos.</li><li>Adoptar medidas para prevenir lesiones dorsolumbares.</li></ul><h3>Responsabilidad del Empleador (Art. 4)</h3><ul><li>Ayudas mecánicas.</li><li>Organización del trabajo.</li><li>Información y capacitación.</li></ul><h3>Peso de Referencia</h3><p>50 kg como referencia (no límite universal).</p>` },
    { tipo:'eval', evaluacion:{ pregunta:"Evaluación Módulo 1: Verdadero o Falso", opciones:[ {texto:"La MMC es solo levantar objetos pesados.", correcta:false}, {texto:"El empleador debe evaluar riesgos en MMC.", correcta:true}, {texto:"El máximo legal siempre es 50 kg.", correcta:false} ] } },
    { tipo:'final', contenido:`<div class="final-curso"><h3>¡Felicidades!</h3><p>Has completado exitosamente el curso:</p><p><strong>Manejo Manual de Cargas - DS 63/2005</strong></p><p>Ahora puedes generar tu certificado de aprobación.</p><button class="certificado-btn" onclick="generarCertificado()">Generar Certificado</button></div>` }
  ],
  "EPP - Uso y Mantención":[ { tipo:'texto', contenido:`<h3>Introducción al curso de EPP</h3><p>Contenido del curso de EPP...</p>` }, { tipo:'final', contenido:`<div class="final-curso"><h3>¡Felicidades!</h3><p>Has completado exitosamente el curso:</p><p><strong>EPP - Uso y Mantención</strong></p><p>Ahora puedes generar tu certificado de aprobación.</p><button class="certificado-btn" onclick="generarCertificado()">Generar Certificado</button></div>` } ]
};

// ====== Navegación ======
function ocultarTodo(){ document.querySelectorAll('.seccion').forEach(s=>s.style.display='none'); document.getElementById('menuPrincipal').style.display='none'; document.getElementById('panelEmpresa').style.display='none'; }
function volverMenu(){ ocultarTodo(); document.getElementById('menuPrincipal').style.display='block'; }
function mostrarTrabajador(){ ocultarTodo(); document.getElementById('seccionTrabajador').style.display='block'; }
function mostrarLoginEmpresa(){ ocultarTodo(); document.getElementById('loginEmpresa').style.display='block'; }

function accederTrabajador(){ const rRaw=document.getElementById('rutAcceso').value.trim(); const r=normalizarRut(rRaw); if(!validarRut(r)){ alert('RUT inválido'); return; } const existe=trabajadores.find(t=>normalizarRut(t.rut)===r); if(existe){ ocultarTodo(); document.getElementById('mosaicoCursos').style.display='block'; } else { alert('RUT no registrado'); } }
function volverTrabajador(){ mostrarTrabajador(); }

function verCurso(nombre){ ocultarTodo(); document.getElementById('moduloCurso').style.display='block'; document.getElementById('tituloCurso').textContent=nombre; cursoActual=nombre; actual=0; mostrarModulo(actual); }

function mostrarModulo(index){ const cont=document.getElementById('contenedorModulos'); cont.innerHTML=''; const modulos=cursos[cursoActual]; if(!modulos||index>=modulos.length) return; const m=modulos[index]; const div=document.createElement('div'); div.className='modulo active';
  if(m.tipo==='texto'){ div.innerHTML=`<h2 class='modulo-titulo'>Módulo ${index+1}</h2><div class='contenido-modulo'>${m.contenido}</div>`; const botones=document.createElement('div'); botones.className='botones-navegacion'; if(index>0){ const bA=document.createElement('button'); bA.textContent='Atrás'; bA.onclick=()=>navegarModulo(-1); botones.appendChild(bA);} else { const spacer=document.createElement('div'); botones.appendChild(spacer);} if(index<modulos.length-1){ const bS=document.createElement('button'); bS.textContent='Siguiente'; bS.onclick=()=>navegarModulo(1); botones.appendChild(bS);} div.appendChild(botones); }
  else if(m.tipo==='eval'){ div.innerHTML=`<h2 class='modulo-titulo'>Evaluación</h2><div class='pregunta'>${m.evaluacion.pregunta}</div><div class='opciones-eval' id='opciones-eval'></div><div id='resultado' class='resultado'></div>`; const opcionesDiv=div.querySelector('#opciones-eval'); m.evaluacion.opciones.forEach((opt,i)=>{ const b=document.createElement('button'); b.className='opcion-btn'; b.textContent=opt.texto; b.onclick=()=>{ verificarRespuesta(opt.correcta,i); }; opcionesDiv.appendChild(b); }); const botones=document.createElement('div'); botones.className='botones-navegacion'; if(index>0){ const bA=document.createElement('button'); bA.textContent='Atrás'; bA.onclick=()=>navegarModulo(-1); botones.appendChild(bA);} div.appendChild(botones); }
  else if(m.tipo==='final'){ div.innerHTML=m.contenido; }
  cont.appendChild(div);
}
function navegarModulo(d){ const modulos=cursos[cursoActual]; actual+=d; if(actual<0) actual=0; if(actual>=modulos.length) actual=modulos.length-1; mostrarModulo(actual); }
function verificarRespuesta(ok,idx){ const res=document.getElementById('resultado'); const ops=document.querySelectorAll('.opcion-btn'); ops.forEach(b=>b.disabled=true); if(ok){ res.textContent='¡Correcto!'; res.className='resultado correcto'; res.style.display='block'; ops[idx].style.backgroundColor='#d4edda'; ops[idx].style.borderColor='#c3e6cb'; setTimeout(()=>navegarModulo(1),1200);} else { res.textContent='Incorrecto. Intente nuevamente.'; res.className='resultado incorrecto'; res.style.display='block'; ops[idx].style.backgroundColor='#f8d7da'; ops[idx].style.borderColor='#f5c6cb'; ops.forEach(b=>b.disabled=false);} }

function generarCertificado(){ const { jsPDF }=window.jspdf; const doc=new jsPDF(); const rutRaw=document.getElementById('rutAcceso').value.trim(); const rut=normalizarRut(rutRaw); const trabajador=trabajadores.find(t=>normalizarRut(t.rut)===rut)||{ nombre:'Nombre del Trabajador', rut:'12.345.678-9', cargo:'Cargo', centro:'Centro' }; const empNombre=document.querySelector('#menuLateral h3')?.textContent||'CAPACITA SM'; const empRut=(document.querySelector('#menuLateral p')?.textContent||'RUT: 76.543.210-1').replace('RUT: ',''); doc.setFontSize(10); doc.setTextColor(100); doc.text(`Empresa: ${empNombre}`,150,20,{align:'right'}); doc.text(`RUT Empresa: ${empRut}`,150,25,{align:'right'}); const ahora=new Date(); doc.text('Fecha emisión: '+ahora.toLocaleDateString('es-CL'),150,30,{align:'right'}); doc.text('Hora emisión: '+ahora.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'}),150,35,{align:'right'}); doc.setFontSize(20); doc.setTextColor(22,71,28); doc.text('CERTIFICADO DE APROBACIÓN',105,50,{align:'center'}); doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text('Se certifica que:',20,70); doc.setFontSize(16); doc.setTextColor(22,71,28); doc.text((trabajador.nombre||'').toUpperCase(),20,80); doc.setFontSize(12); doc.setTextColor(100); doc.text('RUT: '+formatearRut(trabajador.rut||''),20,86); doc.text('Cargo: '+(trabajador.cargo||''),20,92); doc.text('Centro de trabajo: '+(trabajador.centro||''),20,98); const tituloCurso=document.getElementById('tituloCurso').textContent; doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text('Ha completado satisfactoriamente el curso:',20,110); doc.setFontSize(16); doc.setTextColor(22,71,28); doc.text((tituloCurso||'').toUpperCase(),20,120); doc.setFontSize(12); doc.setTextColor(100); doc.text('Modalidad: E-Learning',20,130); doc.text('Duración: 2:00:00 horas cronológicas',20,136); doc.text('Fecha inicio: '+new Date().toLocaleDateString('es-CL'),20,142); doc.text('Fecha término: '+new Date().toLocaleDateString('es-CL'),20,148); doc.setFontSize(10); doc.setTextColor(80); doc.text('Vigencia: 2 años a partir de la fecha de término',20,160); doc.text('Código de validación: '+Math.random().toString(36).substring(2,10).toUpperCase(),20,166); doc.text('Este certificado acredita capacitación para fines internos del SGSST (DS 40/69 y DS 594/99).',20,172); doc.setFontSize(12); doc.setTextColor(0,0,0); doc.text('_________________________',20,190); doc.text('Firma Instructor',20,196); doc.text('_________________________',120,190); doc.text('Firma Representante Legal',120,196); doc.setFontSize(8); doc.setTextColor(150); doc.text('Verificable en el sistema de Capacita SM',105,280,{align:'center'}); doc.save(`Certificado_${(trabajador.nombre||'Trabajador').replace(/\s+/g,'_')}_${(tituloCurso||'Curso').replace(/\s+/g,'_')}.pdf`); }

// ====== Panel Empresa ======
function accederEmpresa(){ const u=document.getElementById('usuarioEmpresa').value.trim(); const p=document.getElementById('claveEmpresa').value.trim(); if(u===usuarioValido && p===claveValida){ ocultarTodo(); document.getElementById('panelEmpresa').style.display='flex'; mostrarSeccion('gestionTrabajadores'); actualizarTabla(); } else { alert('Credenciales incorrectas'); } }
function mostrarSeccion(sec){ document.getElementById('gestionTrabajadores').style.display='none'; document.getElementById('registroCapacitaciones').style.display='none'; document.getElementById(sec).style.display='block'; if(sec==='registroCapacitaciones') cargarListaCapacitaciones(); }
function registrarTrabajador(){ const n=document.getElementById('nombre').value.trim(); let r=document.getElementById('rut').value.trim(); const c=document.getElementById('cargo').value.trim(); const ce=document.getElementById('centro').value.trim(); const f=document.getElementById('fechaIngreso').value; r=normalizarRut(r); if(!(n&&r&&c&&ce&&f)){ alert('Complete todos los campos'); return;} if(!validarRut(r)){ alert('RUT inválido'); return;} if(trabajadores.some(t=>normalizarRut(t.rut)===r)){ alert('Ya existe un trabajador con ese RUT'); return;} trabajadores.push({ nombre:n, rut:formatearRut(r), cargo:c, centro:ce, fechaIngreso:f }); trabajadores.sort((a,b)=>a.nombre.localeCompare(b.nombre)); localStorage.setItem('trabajadores', JSON.stringify(trabajadores)); actualizarTabla(); document.getElementById('nombre').value=''; document.getElementById('rut').value=''; document.getElementById('cargo').value=''; document.getElementById('centro').value=''; document.getElementById('fechaIngreso').value=''; }
function actualizarTabla(){ const t=document.getElementById('tablaTrabajadores'); t.innerHTML=''; trabajadores.forEach((tr,i)=>{ const row=document.createElement('tr'); row.innerHTML=`<td>${tr.rut}</td><td>${tr.nombre}</td><td>${tr.cargo}</td><td>${tr.centro}</td><td>${tr.fechaIngreso}</td><td><button onclick='eliminarTrabajador(${i})'>Eliminar</button></td>`; t.appendChild(row); }); }
function eliminarTrabajador(i){ if(confirm('¿Está seguro que desea eliminar este trabajador?')){ trabajadores.splice(i,1); localStorage.setItem('trabajadores', JSON.stringify(trabajadores)); actualizarTabla(); } }
function exportarTrabajadores(){ let csv='RUT,Nombre,Cargo,Centro,Fecha Ingreso\n'; trabajadores.forEach(t=>{ csv += `"${t.rut}","${t.nombre}","${t.cargo}","${t.centro}","${t.fechaIngreso}"\n`; }); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); const url=URL.createObjectURL(blob); link.href=url; link.download='trabajadores.csv'; link.style.visibility='hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
function importarTrabajadores(input){ const file=input.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=function(e){ const data=e.target.result; if(file.name.endsWith('.csv')){ const lines=data.split(/\r?\n/); const headers=lines[0].split(',').map(h=>h.trim().replace(/"/g,'')); for(let i=1;i<lines.length;i++){ if(lines[i].trim()==='') continue; const values=lines[i].split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(v=>v.trim().replace(/\"/g,'')); const obj={}; headers.forEach((h,j)=>{ obj[h.toLowerCase().replace(/\s+/g,'_')]=values[j]; }); if(obj.rut && obj.nombre){ let r=normalizarRut(obj.rut); if(validarRut(r) && !trabajadores.some(t=>normalizarRut(t.rut)===r)){ trabajadores.push({ rut:formatearRut(r), nombre:obj.nombre, cargo:obj.cargo||'', centro:obj.centro||'', fechaIngreso:obj['fecha_ingreso']||'' }); } } } } else if(file.name.endsWith('.xlsx')){ const workbook=XLSX.read(data,{type:'binary'}); const firstSheet=workbook.Sheets[workbook.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(firstSheet); json.forEach(row=>{ if(row.RUT && row.Nombre){ let r=normalizarRut(row.RUT); if(validarRut(r) && !trabajadores.some(t=>normalizarRut(t.rut)===r)){ trabajadores.push({ rut:formatearRut(r), nombre:row.Nombre, cargo:row.Cargo||'', centro:row.Centro||'', fechaIngreso:row['Fecha Ingreso']||'' }); } } }); }
  trabajadores.sort((a,b)=>a.nombre.localeCompare(b.nombre)); localStorage.setItem('trabajadores', JSON.stringify(trabajadores)); actualizarTabla(); input.value=''; };
  if(file.name.endsWith('.xlsx')) reader.readAsBinaryString(file); else reader.readAsText(file); }

// ====== Capacitaciones ======
function nuevaCapacitacion(){ document.getElementById('formularioCapacitacion').style.display='block'; participantesTemporales=[]; cargarListaTrabajadores(); document.getElementById('listaParticipantes').innerHTML=''; }
function cancelarCapacitacion(){ document.getElementById('formularioCapacitacion').style.display='none'; }
function cargarListaTrabajadores(){ const sel=document.getElementById('listaTrabajadoresSelect'); sel.innerHTML=''; trabajadores.forEach(t=>{ const op=document.createElement('option'); op.value=t.rut; op.textContent=`${t.nombre} (${t.rut}) - ${t.cargo}`; sel.appendChild(op); }); }
function agregarParticipantes(){ const sel=document.getElementById('listaTrabajadoresSelect'); Array.from(sel.selectedOptions).forEach(o=>{ const rut=o.value; if(!participantesTemporales.some(p=>p.rut===rut)){ const t=trabajadores.find(x=>x.rut===rut); if(t) participantesTemporales.push(t); } }); actualizarListaParticipantes(); }
function actualizarListaParticipantes(){ const c=document.getElementById('listaParticipantes'); c.innerHTML=''; participantesTemporales.forEach((p,i)=>{ const div=document.createElement('div'); div.className='participante-item'; div.innerHTML=`<span>${p.nombre} (${p.rut}) - ${p.cargo}</span><button onclick="eliminarParticipante(${i})" style="color:red; background:none; border:none; cursor:pointer;">✕</button>`; c.appendChild(div); }); }
function eliminarParticipante(i){ participantesTemporales.splice(i,1); actualizarListaParticipantes(); }
function guardarCapacitacion(){ const nombreActividad=document.getElementById('nombreActividad').value.trim(); const fechaInicio=document.getElementById('fechaInicio').value; const fechaFin=document.getElementById('fechaFin').value; const modalidad=document.getElementById('modalidad').value; const horas=document.getElementById('horasCapacitacion').value; const tipoActividad=document.getElementById('tipoActividad').value; const responsable=document.getElementById('responsable').value.trim(); const grupoObjetivo=document.getElementById('grupoObjetivo').value.trim(); if(!(nombreActividad&&fechaInicio&&fechaFin&&horas&&participantesTemporales.length)){ alert('Complete todos los campos obligatorios y agregue al menos un participante'); return;} const nueva={ id:Date.now(), nombreActividad, fechaInicio, fechaFin, modalidad, horas, tipoActividad, responsable, grupoObjetivo, participantes:[...participantesTemporales], fechaRegistro:new Date().toISOString() }; capacitaciones.push(nueva); localStorage.setItem('capacitaciones', JSON.stringify(capacitaciones)); document.getElementById('formularioCapacitacion').reset(); document.getElementById('formularioCapacitacion').style.display='none'; participantesTemporales=[]; cargarListaCapacitaciones(); }
function cargarListaCapacitaciones(){ const tb=document.getElementById('listaCapacitaciones'); tb.innerHTML=''; capacitaciones.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nombreActividad}</td><td>${new Date(c.fechaInicio).toLocaleDateString('es-CL')} - ${new Date(c.fechaFin).toLocaleDateString('es-CL')}</td><td>${c.modalidad}</td><td>${c.horas}</td><td>${c.participantes.length}</td><td><button onclick="verDetalleCapacitacion(${c.id})">Ver</button><button onclick="exportarRegistroCapacitacion(${c.id})">Descargar</button><button onclick="eliminarCapacitacion(${c.id})" style="color:red;">Eliminar</button></td>`; tb.appendChild(tr); }); }
function verDetalleCapacitacion(id){ const c=capacitaciones.find(x=>x.id===id); if(!c) return; let html=`<h3>${c.nombreActividad}</h3><p><strong>Fecha:</strong> ${new Date(c.fechaInicio).toLocaleDateString('es-CL')} - ${new Date(c.fechaFin).toLocaleDateString('es-CL')}</p><p><strong>Modalidad:</strong> ${c.modalidad}</p><p><strong>Horas:</strong> ${c.horas}</p><p><strong>Tipo de actividad:</strong> ${c.tipoActividad}</p><p><strong>Responsable:</strong> ${c.responsable}</p><p><strong>Grupo objetivo:</strong> ${c.grupoObjetivo}</p><h4>Participantes (${c.participantes.length}):</h4><table style="width:100%; margin-top:10px;"><thead><tr><th>Nombre</th><th>RUT</th><th>Cargo</th></tr></thead><tbody>`; c.participantes.forEach(p=>{ html+=`<tr><td>${p.nombre}</td><td>${p.rut}</td><td>${p.cargo}</td></tr>`; }); html+=`</tbody></table><div style="margin-top:20px; text-align:center;"><button onclick="cerrarModalDetalle()">Cerrar</button></div>`; const cont=document.getElementById('modalContenido'); cont.innerHTML=html; const modal=document.getElementById('modalDetalle'); modal.style.display='block'; modal.onclick=(e)=>{ if(e.target.id==='modalDetalle') cerrarModalDetalle(); } }
function cerrarModalDetalle(){ document.getElementById('modalDetalle').style.display='none'; }
function eliminarCapacitacion(id){ if(confirm('¿Está seguro que desea eliminar esta capacitación?')){ capacitaciones = capacitaciones.filter(c=>c.id!==id); localStorage.setItem('capacitaciones', JSON.stringify(capacitaciones)); cargarListaCapacitaciones(); } }

function exportarRegistroCapacitacion(id){ const c=capacitaciones.find(x=>x.id===id); if(!c) return; const { jsPDF }=window.jspdf; const doc=new jsPDF(); doc.setFontSize(16); doc.setTextColor(22,71,28); doc.text('REGISTRO DE CAPACITACIÓN',105,20,{align:'center'}); doc.setFontSize(10); doc.setTextColor(0,0,0); doc.text(`Código: 001`,150,30); doc.text(`Versión: 001`,150,35); doc.text(`Fecha aprobación: ${new Date().toLocaleDateString('es-CL')}`,150,40); doc.setFontSize(12); doc.text('1. ANTECEDENTES DEL SOLICITANTE',15,60); doc.setFontSize(10); doc.text('A continuación, se detallan los antecedentes de la actividad de capacitación implementada',15,66); doc.text('para dar cumplimiento a lo establecido en el Sistema de Gestión de SST.',15,71); doc.text('Nombre de la actividad:',15,80); doc.text(c.nombreActividad,60,80); doc.text('Fecha inicio y fin:',15,85); doc.text(`${new Date(c.fechaInicio).toLocaleDateString('es-CL')} - ${new Date(c.fechaFin).toLocaleDateString('es-CL')}`,60,85); doc.text('Modalidad:',15,90); doc.text(c.modalidad,60,90); doc.text('N° de horas:',15,95); doc.text(String(c.horas),60,95); doc.text('Tipo de actividad:',15,100); doc.text(c.tipoActividad,60,100); if(c.tipoActividad==='Interna'){ doc.text('Responsable:',15,105); doc.text(c.responsable||'',60,105); doc.text('Cargo:',15,110); doc.text('JEFE DE RRHH',60,110); }
  const texto=(c.grupoObjetivo||'').toString(); const split=doc.splitTextToSize(texto,180); doc.text('Grupo objetivo - Observaciones:',15,115); doc.text(split,15,120); doc.setFontSize(12); doc.text('2. INFORMACIÓN PARTICIPANTES',15,140); doc.setFontSize(10); let y=150; doc.text('Nombre del participante',15,y); doc.text('Rut',90,y); doc.text('Cargo',130,y); doc.text('Firma',170,y); y+=3; doc.line(15,y,190,y); y+=7; c.participantes.forEach(p=>{ doc.text(p.nombre||'',15,y); doc.text(p.rut||'',90,y); doc.text(p.cargo||'',130,y); y+=8; if(y>270){ doc.addPage(); y=20; } }); doc.save(`Registro_Capacitacion_${c.nombreActividad.replace(/\s+/g,'_')}.pdf`); }

function exportarCapacitaciones(){ const { jsPDF }=window.jspdf; const doc=new jsPDF(); doc.setFontSize(16); doc.text('LISTADO DE CAPACITACIONES',105,20,{align:'center'}); let y=30; capacitaciones.forEach((cap,idx)=>{ doc.setFontSize(12); doc.text(`${idx+1}. ${cap.nombreActividad}`,20,y); doc.setFontSize(10); doc.text(`Fecha: ${new Date(cap.fechaInicio).toLocaleDateString('es-CL')} - ${new Date(cap.fechaFin).toLocaleDateString('es-CL')}`,20,y+5); doc.text(`Modalidad: ${cap.modalidad}  ·  Horas: ${cap.horas}`,20,y+10); doc.text(`Participantes: ${cap.participantes.length}`,20,y+15); y+=25; if(y>270){ doc.addPage(); y=20; } }); doc.save('Listado_Capacitaciones.pdf'); }

function filtrarCapacitaciones(){ const f=document.getElementById('filtroCapacitaciones').value.toLowerCase(); const filas=document.getElementById('listaCapacitaciones').getElementsByTagName('tr'); for(let fila of filas){ const txt=fila.textContent.toLowerCase(); fila.style.display = txt.includes(f) ? '' : 'none'; } }
function filtrarTrabajadores(){ const f=document.getElementById('filtroTrabajadores').value.toLowerCase(); const filas=document.getElementById('tablaTrabajadores').getElementsByTagName('tr'); for(let fila of filas){ const txt=fila.textContent.toLowerCase(); fila.style.display = txt.includes(f) ? '' : 'none'; } }

// ====== Init ======
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('menuPrincipal').style.display='block'; actualizarTabla(); cargarListaCapacitaciones(); });
</script>
</body>
</html>





